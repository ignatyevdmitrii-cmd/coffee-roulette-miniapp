<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>–†—É–ª–µ—Ç–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#070814; --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14); --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65); --accent:#7cf7ff;
    }
    html,body{height:100%; margin:0; color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    body{
      background: radial-gradient(900px 650px at 50% 10%, #1a1f4d 0%, var(--bg) 55%, #03030a 100%);
      display:grid; place-items:center; padding:16px;
    }
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
    }
    .card{
      width:min(560px,94vw);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10) 0%, rgba(255,255,255,.05) 100%);
      border:1px solid var(--stroke);
      box-shadow:0 22px 70px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.12);
      overflow:hidden;
    }
    .top{padding:16px 18px 10px; display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .title{font-size:18px; font-weight:900}
    .sub{font-size:13px; color:var(--muted); margin-top:4px}
    .pill{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.22);
      padding:6px 10px; border-radius:999px;
      font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .stage{position:relative; padding:8px 18px 18px; display:grid; place-items:center;}
    canvas{width:min(420px,86vw); height:min(420px,86vw); display:block}
    .pointer{
      position:absolute; top:14px; left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:26px solid rgba(255,255,255,.92);
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.65));
    }
    .glow{
      position:absolute; width:min(460px,92vw); height:min(460px,92vw);
      border-radius:50%;
      background:radial-gradient(circle at 50% 40%, rgba(124,247,255,.22), rgba(124,247,255,0) 62%);
      pointer-events:none;
    }
    .controls{padding:0 18px 18px; display:grid; gap:10px;}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(124,247,255,.22), rgba(124,247,255,.08));
      color:var(--txt); font-weight:900; letter-spacing:.6px;
      padding:14px; border-radius:16px; cursor:pointer;
      box-shadow:0 16px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.14);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.secondary{background: rgba(255,255,255,.06); font-weight:800;}
    .note{font-size:12px; color:var(--muted); line-height:1.35}
    .result{padding:12px 18px 18px; border-top:1px solid rgba(255,255,255,.10); display:none; gap:10px;}
    .result.show{display:grid}
    .prize{padding:12px 14px; border-radius:16px; background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12);}
    .prize .h{font-weight:900; font-size:14px}
    .prize .d{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35}
    .tiny{font-size:11px; color:rgba(255,255,255,.45)}
  </style>
</head>
<body>
  <div class="card">
    <div class="top">
      <div>
        <div class="title">üé∞ –†—É–ª–µ—Ç–∫–∞ –ø—Ä–∏–∑–æ–≤</div>
        <div class="sub" id="sub">–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å –∏ –∑–∞–±–∏—Ä–∞—Ç—å –ø—Ä–∏–∑.</div>
      </div>
      <div class="pill" id="ctx">–í–Ω–µ Telegram</div>
    </div>

    <div class="stage">
      <div class="glow"></div>
      <div class="pointer"></div>
      <canvas id="wheel" width="900" height="900"></canvas>
    </div>

    <div class="controls">
      <button class="btn" id="spin">–ö–†–£–¢–ò–¢–¨</button>
      <button class="btn secondary" id="claim" disabled>–ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó</button>
      <div class="note" id="note">
        –í–Ω—É—Ç—Ä–∏ Telegram –∫–Ω–æ–ø–∫–∞ ‚Äú–ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó‚Äù –æ—Ç–ø—Ä–∞–≤–∏—Ç –∑–∞—è–≤–∫—É –±–æ—Ç—É.
      </div>
      <div class="tiny" id="dbg"></div>
    </div>

    <div class="result" id="result">
      <div class="prize">
        <div class="h" id="prizeTitle">‚Äî</div>
        <div class="d" id="prizeDesc">‚Äî</div>
      </div>
      <div class="tiny">–°–æ–≤–µ—Ç: –ø–æ—Å–ª–µ –ø—Ä–∏–∑–∞ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó‚Äù ‚Äî –±–æ—Ç –ø–æ–ª—É—á–∏—Ç –∑–∞—è–≤–∫—É.</div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); document.getElementById('ctx').textContent="Telegram ‚úÖ"; }

  // —Ç–æ—á–∫–∞ –∏–∑ URL: ?p=L189 (–±–æ—Ç –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å Mini App —Ç–∞–∫)
  const urlP = new URLSearchParams(location.search).get("p") || "";
  if (urlP) document.getElementById("sub").textContent = `–¢–æ—á–∫–∞: ${urlP}. –ö—Ä—É—Ç–∏—Ç–µ —Ä—É–ª–µ—Ç–∫—É –∏ –∑–∞–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∏–∑.`;

  const PRIZES = [
    { id:"card",  label:"–û—Ç–∫—Ä—ã—Ç–∫–∞ üíå", desc:"–¶–∏—Ñ—Ä–æ–≤–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞ (—Ä–∞–Ω–¥–æ–º).", w:10 },
    { id:"val",   label:"–í–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ ‚ù§Ô∏è", desc:"–¶–∏—Ñ—Ä–æ–≤–∞—è –≤–∞–ª–µ–Ω—Ç–∏–Ω–∫–∞ (—Ä–∞–Ω–¥–æ–º).", w:10 },
    { id:"st1",   label:"–°—Ç–∏–∫–µ—Ä–ø–∞–∫ #1 üß©", desc:"–¶–∏—Ñ—Ä–æ–≤–æ–π —Å—Ç–∏–∫–µ—Ä–ø–∞–∫.", w:10 },
    { id:"st2",   label:"–°—Ç–∏–∫–µ—Ä–ø–∞–∫ #2 üéÅ", desc:"–§–∏–∑–∏—á–µ—Å–∫–∏–π (–≤—ã–¥–∞—á–∞ –≤—Ä—É—á–Ω—É—é).", w:10 },
    { id:"retry", label:"–í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ üîÅ", desc:"–ú–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å –µ—â—ë —Ä–∞–∑ —Å—Ä–∞–∑—É.", w:20 },
    { id:"b50",   label:"+50 –±–æ–Ω—É—Å–æ–≤ ‚òïÔ∏è",  desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:10 },
    { id:"b100",  label:"+100 –±–æ–Ω—É—Å–æ–≤ ‚òïÔ∏è", desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:10 },
    { id:"b200",  label:"+200 –±–æ–Ω—É—Å–æ–≤ ‚òïÔ∏è", desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:5  },
    { id:"b500",  label:"+500 –±–æ–Ω—É—Å–æ–≤ ‚òïÔ∏è", desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:3  },
    { id:"b1000", label:"+1000 –±–æ–Ω—É—Å–æ–≤ üëë", desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:3  },
    { id:"b2500", label:"+2500 –±–æ–Ω—É—Å–æ–≤ üëë", desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:2  },
    { id:"b5000", label:"+5000 –±–æ–Ω—É—Å–æ–≤ üëë", desc:"1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å.", w:1  },
    { id:"box",   label:"–ó–û–õ–û–¢–û–ô –ë–ò–õ–ï–¢: –°—É–ø–µ—Ä–±–æ–∫—Å ‚ú®", desc:"–†–µ–¥–∫–∏–π –ø—Ä–∏–∑. –í—ã–¥–∞—á–∞ –≤—Ä—É—á–Ω—É—é.", w:0.5 },
  ];

  function pickPrize(){
    const total = PRIZES.reduce((s,p)=>s+p.w,0);
    let r = Math.random()*total;
    for (const p of PRIZES){ r -= p.w; if (r<=0) return p; }
    return PRIZES[0];
  }

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width = 900*DPR; canvas.height = 900*DPR; ctx.setTransform(DPR,0,0,DPR,0,0);

  const cx=450, cy=450, R=360;
  const segments = PRIZES.map(p=>p.label);
  const N = segments.length;
  const arc = (Math.PI*2)/N;

  function drawWheel(a){
    ctx.clearRect(0,0,900,900);
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(a);

    const grd = ctx.createRadialGradient(0,-120,40, 0,0,R+30);
    grd.addColorStop(0, "rgba(124,247,255,.22)");
    grd.addColorStop(.35, "rgba(255,255,255,.08)");
    grd.addColorStop(1, "rgba(0,0,0,.38)");
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(0,0,R+26,0,Math.PI*2); ctx.fill();

    for(let i=0;i<N;i++){
      const a0=i*arc, a1=a0+arc;
      const g = ctx.createLinearGradient(Math.cos(a0)*R,Math.sin(a0)*R,Math.cos(a1)*R,Math.sin(a1)*R);
      const odd=i%2;
      g.addColorStop(0, odd ? "rgba(124,247,255,.20)" : "rgba(255,80,220,.18)");
      g.addColorStop(1, odd ? "rgba(255,255,255,.08)" : "rgba(255,255,255,.06)");
      ctx.fillStyle=g;

      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,a0,a1); ctx.closePath(); ctx.fill();
      ctx.strokeStyle="rgba(255,255,255,.12)"; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,R,a0,a1); ctx.stroke();

      ctx.save();
      ctx.rotate(a0+arc/2);
      ctx.translate(0,-R*0.72);
      ctx.rotate(Math.PI/2);
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="700 18px system-ui";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      const t=segments[i];
      ctx.fillText(t.length>18 ? t.slice(0,18)+"‚Ä¶" : t, 0, 0);
      ctx.restore();
    }

    const ig = ctx.createRadialGradient(0,-80,20, 0,0,200);
    ig.addColorStop(0,"rgba(255,255,255,.18)");
    ig.addColorStop(1,"rgba(0,0,0,.35)");
    ctx.fillStyle=ig; ctx.beginPath(); ctx.arc(0,0,210,0,Math.PI*2); ctx.fill();

    ctx.beginPath(); ctx.ellipse(-80,-120,180,110,-0.35,0,Math.PI*2);
    ctx.fillStyle="rgba(255,255,255,.07)"; ctx.fill();

    ctx.beginPath(); ctx.arc(0,0,R+2,0,Math.PI*2);
    ctx.strokeStyle="rgba(255,255,255,.22)"; ctx.lineWidth=4; ctx.stroke();

    ctx.restore();
  }

  let angle=0; drawWheel(angle);
  let spinning=false; let lastPrize=null;

  function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

  function spin(){
    if (spinning) return;
    spinning=true; lastPrize=null;
    document.getElementById('spin').disabled=true;
    document.getElementById('claim').disabled=true;
    document.getElementById('result').classList.remove('show');

    const prize = pickPrize();
    const idx = PRIZES.findIndex(p=>p.id===prize.id);
    const target = (Math.PI*2)*6 + (Math.PI*2) - (idx*arc + arc/2);
    const start = angle;
    const dur = 4200;
    const t0 = performance.now();

    function frame(now){
      const t = Math.min(1,(now-t0)/dur);
      angle = start + (target-start)*easeOutCubic(t);
      drawWheel(angle);
      if (t<1) requestAnimationFrame(frame);
      else finish(prize);
    }
    requestAnimationFrame(frame);
  }

  function finish(prize){
    lastPrize=prize;
    document.getElementById('prizeTitle').textContent=prize.label;
    document.getElementById('prizeDesc').textContent=prize.desc;
    document.getElementById('result').classList.add('show');

    document.getElementById('spin').disabled=false;
    document.getElementById('claim').disabled = (prize.id==="retry");
    spinning=false;
  }

  function claim(){
    if (!lastPrize) return;
    const payload = { type:"CLAIM", prize:lastPrize, point:urlP, ts:Date.now() };
    if (tg) {
      tg.sendData(JSON.stringify(payload));
      tg.showAlert("‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –±–æ—Ç—É");
    } else {
      alert("–û—Ç–∫—Ä–æ–π—Ç–µ –≤–Ω—É—Ç—Ä–∏ Telegram.\n\n"+JSON.stringify(payload,null,2));
    }
  }

  document.getElementById('spin').onclick=spin;
  document.getElementById('claim').onclick=claim;

  document.getElementById('dbg').textContent = tg
    ? `user_id: ${tg.initDataUnsafe?.user?.id || "-"} | point: ${urlP || "-"}`
    : "debug: not in Telegram";
</script>
</body>
</html>
